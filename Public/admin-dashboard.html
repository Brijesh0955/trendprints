<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TRENDPRINTS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: #f0f2f5;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .admin-badge {
            background: #ffd700;
            color: #333;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            margin-right: 1rem;
        }

        .logout-btn {
            background: rgba(255,71,87,0.2);
            color: white;
            padding: 0.5rem 1.5rem;
            text-decoration: none;
            border-radius: 50px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,71,87,0.3);
        }

        .container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 2rem 0;
        }

        .sidebar a {
            display: block;
            padding: 1rem 2rem;
            color: #333;
            text-decoration: none;
            transition: 0.3s;
            border-left: 4px solid transparent;
        }

        .sidebar a:hover, .sidebar a.active {
            background: #f0f2ff;
            border-left-color: #764ba2;
            color: #764ba2;
        }

        .content {
            flex: 1;
            padding: 2rem;
            background: #f8fafc;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #764ba2;
        }

        .stat-number small {
            font-size: 0.9rem;
            color: #999;
        }

        .orders-table {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            background: #f8f9fa;
            color: #555;
            font-weight: 600;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.3rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-shipped {
            background: #d4edda;
            color: #155724;
        }

        .status-delivered {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .view-btn {
            padding: 0.3rem 1rem;
            background: #764ba2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        .view-btn:hover {
            background: #5a3d80;
            transform: translateY(-2px);
        }

        .order-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: 0.3s;
        }

        .close-modal:hover {
            color: #333;
            transform: rotate(90deg);
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .address-block {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">üëë TRENDPRINTS ADMIN</div>
        <div>
            <span class="admin-badge">Administrator</span>
            <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="sidebar">
            <a href="#" onclick="showSection('dashboard')" class="active">üìä Dashboard</a>
            <a href="#" onclick="showSection('orders')">üì¶ Orders</a>
            <a href="#" onclick="showSection('products')">üõçÔ∏è Products</a>
            <a href="#" onclick="showSection('users')">üë• Users</a>
            <a href="/" target="_blank">üè™ View Store</a>
        </div>

        <div class="content" id="contentArea">
            <!-- Dynamic content will load here -->
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="order-details-modal" id="orderModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeOrderModal()">&times;</span>
            <h2 style="margin-bottom:1rem;">üìã Order Details</h2>
            <div id="orderDetails"></div>
        </div>
    </div>

    <!-- Product Edit Modal -->
    <div class="order-details-modal" id="productModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeProductModal()">&times;</span>
            <h2 style="margin-bottom:1rem;">‚úèÔ∏è Edit Product</h2>
            <div id="productEditForm"></div>
        </div>
    </div>

    <script>
        let currentSection = 'dashboard';

        document.addEventListener('DOMContentLoaded', () => {
            showSection('dashboard');
        });

        function showSection(section) {
            currentSection = section;
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');

            if (section === 'dashboard') loadDashboard();
            else if (section === 'orders') loadOrders();
            else if (section === 'products') loadProducts();
            else if (section === 'users') loadUsers();
        }

        // ========== DASHBOARD ==========
        async function loadDashboard() {
            const content = document.getElementById('contentArea');
            content.innerHTML = '<div class="loading">Loading dashboard...</div>';

            try {
                const res = await fetch('/api/admin/stats');
                const stats = await res.json();

                content.innerHTML = `
                    <h2 style="margin-bottom:2rem;">üìä Dashboard Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Orders</h3>
                            <div class="stat-number">${stats.totalOrders}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Products</h3>
                            <div class="stat-number">${stats.totalProducts}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Users</h3>
                            <div class="stat-number">${stats.totalUsers}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Revenue</h3>
                            <div class="stat-number">‚Çπ${stats.totalRevenue}</div>
                        </div>
                    </div>
                    <h3 style="margin:2rem 0 1rem;">üì¶ Recent Orders</h3>
                    <div id="recentOrders"></div>
                `;

                // Load recent orders
                const ordersRes = await fetch('/api/admin/orders');
                const orders = await ordersRes.json();
                displayOrdersTable('recentOrders', orders.slice(0, 5));
            } catch (err) {
                content.innerHTML = '<div class="error-message">Error loading dashboard</div>';
            }
        }

        // ========== ORDERS ==========
        async function loadOrders() {
            const content = document.getElementById('contentArea');
            content.innerHTML = '<div class="loading">Loading orders...</div>';

            try {
                const res = await fetch('/api/admin/orders');
                const orders = await res.json();

                content.innerHTML = `
                    <h2 style="margin-bottom:2rem;">üì¶ All Orders</h2>
                    <div id="allOrders"></div>
                `;

                displayOrdersTable('allOrders', orders);
            } catch (err) {
                content.innerHTML = '<div class="error-message">Error loading orders</div>';
            }
        }

        function displayOrdersTable(elementId, orders) {
            const container = document.getElementById(elementId);
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:2rem;">No orders found</p>';
                return;
            }

            container.innerHTML = `
                <div class="orders-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td>#${order._id.slice(-6)}</td>
                                    <td>
                                        <strong>${order.userId?.username || 'Guest'}</strong><br>
                                        <small style="color:#666;">${order.userId?.email || ''}</small>
                                    </td>
                                    <td>${order.items.length} items</td>
                                    <td><strong>‚Çπ${order.total}</strong></td>
                                    <td>
                                        <select onchange="updateOrderStatus('${order._id}', this.value)" 
                                                class="status-badge status-${order.status.toLowerCase()}">
                                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                            <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                            <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                    </td>
                                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                                    <td>
                                        <button class="view-btn" onclick="viewOrderDetails('${order._id}')">View</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const res = await fetch('/api/admin/orders/' + orderId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (res.ok) {
                    alert('‚úÖ Order status updated!');
                    if (currentSection === 'dashboard') loadDashboard();
                    else loadOrders();
                }
            } catch (err) {
                alert('Error updating status');
            }
        }
// ========== PRODUCT FUNCTIONS ==========
async function loadProducts() {
    const content = document.getElementById('contentArea');
    content.innerHTML = '<div class="loading">Loading products...</div>';

    try {
        const res = await fetch('/api/admin/products');
        const products = await res.json();

        content.innerHTML = `
            <h2 style="margin-bottom:2rem;">üì¶ Manage Products</h2>
            <div class="orders-table">
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr>
                                <td>
                                    <img src="/images/${product.image}" 
                                         alt="${product.name}"
                                         style="width:50px; height:50px; object-fit:cover; border-radius:5px;"
                                         onerror="this.src='https://placehold.co/50x50/764ba2/white?text=IMG'">
                                </td>
                                <td>${product.name}</td>
                                <td>‚Çπ${product.price}</td>
                                <td>${product.category}</td>
                                <td>${product.stock}</td>
                                <td>
                                    <button class="view-btn" onclick="editProduct('${product._id}')" style="margin-right:5px;">Edit</button>
                                    <button class="view-btn" onclick="deleteProduct('${product._id}')" style="background:#ff4757;">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (err) {
        content.innerHTML = '<div class="error-message">Error loading products</div>';
    }
}

// ========== USER FUNCTIONS ==========
async function loadUsers() {
    const content = document.getElementById('contentArea');
    content.innerHTML = '<div class="loading">Loading users...</div>';

    try {
        const res = await fetch('/api/admin/users');
        const users = await res.json();

        content.innerHTML = `
            <h2 style="margin-bottom:2rem;">üë• Manage Users</h2>
            <div class="orders-table">
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Joined</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>
                                    <span class="status-badge ${user.role === 'admin' ? 'status-shipped' : 'status-pending'}">
                                        ${user.role || 'user'}
                                    </span>
                                </td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td>
                                    ${user.role !== 'admin' ? 
                                        `<button class="view-btn" onclick="deleteUser('${user._id}')" style="background:#ff4757;">Delete</button>` : 
                                        '<span style="color:#999;">Protected</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (err) {
        content.innerHTML = '<div class="error-message">Error loading users</div>';
    }
}

// ========== PRODUCT ACTIONS ==========
async function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    
    try {
        const res = await fetch('/api/admin/products/' + productId, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            alert('Product deleted!');
            loadProducts();
        }
    } catch (err) {
        alert('Error deleting product');
    }
}

async function editProduct(productId) {
    // Fetch product details
    const res = await fetch('/api/admin/products');
    const products = await res.json();
    const product = products.find(p => p._id === productId);
    
    // Show edit modal (implement as needed)
    console.log('Edit product:', product);
}

// ========== USER ACTIONS ==========
async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    
    try {
        const res = await fetch('/api/admin/users/' + userId, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            alert('User deleted!');
            loadUsers();
        }
    } catch (err) {
        alert('Error deleting user');
    }
}
        async function viewOrderDetails(orderId) {
            try {
                const res = await fetch('/api/admin/orders');
                const orders = await res.json();
                const order = orders.find(o => o._id === orderId);

                const detailsDiv = document.getElementById('orderDetails');
                detailsDiv.innerHTML = `
                    <div style="margin-bottom:1rem;">
                        <p><strong>üÜî Order ID:</strong> ${order._id}</p>
                        <p><strong>üë§ Customer:</strong> ${order.userId?.username || 'Guest'}</p>
                        <p><strong>üìß Email:</strong> ${order.userId?.email || 'N/A'}</p>
                        <p><strong>üìÖ Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                        <p><strong>üìä Status:</strong> <span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span></p>
                        <p><strong>üí≥ Payment:</strong> ${order.paymentMethod || 'COD'}</p>
                    </div>
                    
                    <h3 style="margin:1rem 0;">üõí Items:</h3>
                    ${order.items.map(item => `
                        <div class="order-item">
                            <span>${item.name} (${item.size || 'M'}) x ${item.quantity}</span>
                            <span><strong>‚Çπ${item.price * item.quantity}</strong></span>
                        </div>
                    `).join('')}
                    
                    <div class="address-block">
                        <h3 style="margin-bottom:0.5rem;">üìç Shipping Address:</h3>
                        <p><strong>${order.address?.fullName || 'N/A'}</strong><br>
                        üìû ${order.address?.phone || 'N/A'}<br>
                        üè† ${order.address?.address || 'N/A'}<br>
                        üèôÔ∏è ${order.address?.city || 'N/A'} - ${order.address?.pincode || 'N/A'}</p>
                    </div>
                    
                    <h3 style="margin-top:1rem; text-align:right;">Total: <span style="color:#764ba2;">‚Çπ${order.total}</span></h3>
                `;

                document.getElementById('orderModal').style.display = 'flex';
            } catch (err) {
                alert('Error loading order details');
            }
        }

        // ========== PRODUCTS ==========
        async function loadProducts() {
            const content = document.getElementById('contentArea');
            content.innerHTML = '<div class="loading">Loading products...</div>';

            try {
                const res = await fetch('/api/admin/products');
                const products = await res.json();

                content.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                        <h2>üõçÔ∏è Manage Products</h2>
                        <button class="view-btn" style="padding:0.8rem 2rem;" onclick="showAddProductForm()">+ Add Product</button>
                    </div>
                    <div class="orders-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Category</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => `
                                    <tr>
                                        <td>
                                            <img src="/images/${product.image}" 
                                                 alt="${product.name}"
                                                 style="width:50px; height:50px; object-fit:cover; border-radius:5px;"
                                                 onerror="this.src='https://placehold.co/50x50/764ba2/white?text=IMG'">
                                        </td>
                                        <td>${product.name}</td>
                                        <td>‚Çπ${product.price}</td>
                                        <td>${product.category}</td>
                                        <td>${product.stock}</td>
                                        <td>
                                            <button class="view-btn" onclick="editProduct('${product._id}')" style="margin-right:5px;">Edit</button>
                                            <button class="view-btn" onclick="deleteProduct('${product._id}')" style="background:#ff4757;">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<div class="error-message">Error loading products</div>';
            }
        }

        // ========== USERS ==========
        async function loadUsers() {
            const content = document.getElementById('contentArea');
            content.innerHTML = '<div class="loading">Loading users...</div>';

            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();

                content.innerHTML = `
                    <h2 style="margin-bottom:2rem;">üë• Manage Users</h2>
                    <div class="orders-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${user.username}</td>
                                        <td>${user.email}</td>
                                        <td>
                                            <span class="status-badge ${user.role === 'admin' ? 'status-shipped' : 'status-pending'}">
                                                ${user.role || 'user'}
                                            </span>
                                        </td>
                                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                        <td>
                                            ${user.role !== 'admin' ? 
                                                `<button class="view-btn" onclick="deleteUser('${user._id}')" style="background:#ff4757;">Delete</button>` : 
                                                '<span style="color:#999;">Protected</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<div class="error-message">Error loading users</div>';
            }
        }

        // ========== MODAL FUNCTIONS ==========
        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Export functions to global scope
        window.showSection = showSection;
        window.updateOrderStatus = updateOrderStatus;
        window.viewOrderDetails = viewOrderDetails;
        window.closeOrderModal = closeOrderModal;
        window.closeProductModal = closeProductModal;
        window.loadProducts = loadProducts;
        window.loadUsers = loadUsers;
    </script>
</body>
</html>